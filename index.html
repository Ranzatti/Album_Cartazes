<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat치logo de Cartazes de Filmes</title>

    <link rel="icon"
          href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>游꿟</text></svg>">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fundo-claro': '#eeeeee', // Cinza claro quase branco
                        'principal': '#3b82f6',    // Azul padr칚o para destaque (ex: + Novo)
                        'suave': '#e5e7eb',        // Cinza bem claro para cards/bordas
                        'texto-suave': '#6b7280',  // Cinza m칠dio para texto secund치rio
                        'destaque-card': '#bfdbfe', // Azul claro sutil para hover/botoes
                        'danger': '#ef4444',       // Vermelho padr칚o para Excluir
                        'edit': '#10b981',         // Verde para Editar
                    }
                }
            }
        }
    </script>
    <style>
        .card-poster.card-poster {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background-color: #f3f4f6;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;

            /* NOVO: Propriedades para fallback */
            display: flex; /* Garante que o texto possa ser centralizado */
            align-items: center;
            justify-content: center;
            color: #6b7280; /* text-texto-suave */
            font-weight: bold;
            font-size: 1.25rem; /* text-xl */
            text-align: center;
        }

        #poster-preview {
            width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 0.5rem;
            background-color: #f3f4f6;
        }

        .poster-area {
            position: relative;
            overflow: hidden; /* Garante que nada transborde */
        }

        .input-uppercase {
            text-transform: uppercase;
        }

        .input-icon-group {
            position: relative;
            display: flex;
            align-items: center;
            border: 1px solid #e5e7eb; /* Cor de borda suave */
            border-radius: 0.5rem;
            overflow: hidden;
            width: 100%;
            height: 42px; /* Altura fixa para alinhamento */
        }

        .input-icon-group input {
            border: none !important;
            box-shadow: none !important;
            width: 100%;
            height: 100%;
            padding: 0.5rem;
            flex-grow: 1;
        }

        .input-icon-group a {
            flex-shrink: 0;
            width: 42px; /* Largura fixa para o bot칚o */
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border-left: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body class="bg-fundo-claro min-h-screen p-4 sm:p-8">

<div id="loading-spinner"
     class="fixed inset-0 bg-fundo-claro bg-opacity-75 z-[60] hidden flex-col items-center justify-center">
    <i class="fas fa-spinner fa-spin text-principal text-5xl mb-4"></i>
    <p class="text-xl text-gray-700 font-semibold">Carregando cat치logo...</p>
</div>

<div class="max-w-7xl mx-auto">
    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
        <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800 mb-4 sm:mb-0 flex items-center">
            游꿟 Cat치logo de Cartazes de Filmes
            <span id="contador-registros"
                  class="ml-4 text-base font-semibold bg-principal text-white px-3 py-1 rounded-full">
            00 Registros
        </span>
        </h1>

        <h1 class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0 flex items-center">
        </h1>

        <div class="flex space-x-3">
            <button id="btn-modal-grafico"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 flex items-center">
                <i class="fas fa-chart-bar mr-2"></i> GR츼FICO
            </button>

            <button id="btn-login"
                    class="bg-texto-suave text-white px-4 py-2 rounded-lg shadow-md hover:bg-principal transition duration-150 flex items-center">
                <i class="fas fa-sign-in-alt mr-2"></i> Login
            </button>

            <button id="btn-novo-filme"
                    class="bg-principal hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 flex items-center">
                <i class="fas fa-plus mr-2"></i> NOVO
            </button>
        </div>

    </header>

    <div id="opcoes-busca-container" class="bg-white p-4 rounded-lg shadow-md mb-6 border border-suave">

        <h2 id="btn-toggle-busca"
            class="text-lg font-semibold text-gray-700 mb-3 flex items-center justify-between cursor-pointer p-1">
            <span class="flex items-center">
                <i class="fas fa-sort-amount-down-alt mr-2 text-principal"></i>
                OP칂칏ES E BUSCA
            </span>
            <i id="icone-toggle-busca" class="fas fa-chevron-down text-principal transition-transform duration-300"></i>
        </h2>

        <div id="conteudo-busca-colapsavel"
             class="overflow-hidden transition-all duration-300 ease-in-out max-h-0 border-t">

            <hr class="mb-4 border-suave">

            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <div class="flex-grow">
                    <label for="filtro-titulo" class="block text-sm font-medium text-gray-700 mb-1">Buscar por
                        T칤tulo:</label>
                    <input type="text" id="filtro-titulo" placeholder="Digite o t칤tulo ou parte dele..."
                           class="w-full p-2 border border-suave rounded-lg focus:ring-principal focus:border-principal">
                </div>

                <div class="sm:w-36">
                    <label for="filtro-ano" class="block text-sm font-medium text-gray-700 mb-1">Buscar por Ano:</label>
                    <input type="text" id="filtro-ano" placeholder="Ex: 1999"
                           class="w-full p-2 border border-suave rounded-lg focus:ring-principal focus:border-principal">
                </div>

                <div class="sm:w-36">
                    <label for="filtro-cores" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Cor:</label>
                    <select id="filtro-cores"
                            class="w-full p-2 border border-suave rounded-lg focus:ring-principal focus:border-principal text-gray-700">
                        <option value="">Todos</option>
                        <option value="Cores">Cores</option>
                        <option value="Preto Branco">Preto & Branco</option>
                    </select>
                </div>
            </div>
            <div class="flex flex-wrap gap-4 items-center border-t pt-3 border-suave">
                <span class="text-sm font-semibold text-gray-700">Ordena칞칚o:</span>
                <select id="sort-criterio"
                        class="p-2 border border-suave rounded-lg focus:ring-principal focus:border-principal text-sm">
                    <option value="id">ID</option>
                    <option value="data_release" selected>Ano</option>
                    <option value="titulo_original">T칤tulo Original</option>
                    <option value="titulo_traduzido">T칤tulo Traduzido</option>
                </select>

                <select id="sort-ordem"
                        class="p-2 border border-suave rounded-lg focus:ring-principal focus:border-principal text-sm">
                    <option value="crescente">Crescente</option>
                    <option value="decrescente">Decrescente</option>
                </select>
            </div>
        </div>
    </div>

    <main id="grade-filmes"
          class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
        <p id="msg-sem-filmes" class="col-span-full text-center text-texto-suave italic hidden">Nenhum filme catalogado.
            Use o bot칚o "+ NOVO" para come칞ar!</p>
    </main>

    <div id="paginacao-container" class="mt-6 flex justify-center items-center space-x-4">
        <button id="btn-primeira" disabled
                class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg text-sm transition duration-300 disabled:opacity-50">
            <i class="fas fa-angle-double-left mr-2"></i> Primeira
        </button>

        <button id="btn-anterior" disabled
                class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg text-sm transition duration-300 disabled:opacity-50">
            <i class="fas fa-arrow-left mr-2"></i> Anterior
        </button>

        <span id="info-paginacao" class="text-lg font-semibold text-gray-700">P치gina 1 de 1</span>

        <button id="btn-proximo" disabled
                class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg text-sm transition duration-300 disabled:opacity-50">
            Pr칩ximo <i class="fas fa-arrow-right ml-2"></i>
        </button>

        <button id="btn-ultima" disabled
                class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg text-sm transition duration-300 disabled:opacity-50">
            칔ltima <i class="fas fa-angle-double-right ml-2"></i>
        </button>
    </div>

</div>

<div id="modal-filme" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl transform transition-all duration-300 overflow-y-auto max-h-[90vh]">
        <div class="p-6 border-b border-suave flex justify-between items-center">
            <h2 class="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                <i class="fas fa-sort-amount-down-alt mr-2 text-texto-suave"></i> OP칂칏ES E BUSCA
            </h2>
            <h2 id="modal-titulo" class="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                <i class="fas fa-film mr-2 text-texto-suave"></i> T칤tulo do Filme - Cat치logo
            </h2>
            <button id="btn-fechar-modal" class="text-gray-500 hover:text-danger text-xl">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <form id="form-filme" class="p-6 space-y-4">
            <input type="hidden" id="filme-id">

            <div class="border p-4 rounded-lg bg-gray-50 mb-4">
                <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-search mr-2"></i> SELECIONE O MODO DE BUSCA
                </h3>
                <div class="flex gap-6">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="modoBusca" id="radio-busca-titulo" value="titulo" checked
                               class="h-4 w-4 text-principal focus:ring-principal border-gray-300">
                        <span class="ml-2 text-sm text-gray-700 font-semibold">Busca por T칤tulo (TMDb)</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="modoBusca" id="radio-busca-tmdb-id" value="id"
                               class="h-4 w-4 text-principal focus:ring-principal border-gray-300">
                        <span class="ml-2 text-sm text-gray-700 font-semibold">Busca por ID (TMDb)</span>
                    </label>
                </div>
            </div>

            <div id="busca-id-container" class="border p-4 rounded-lg bg-gray-50">
                <h3 class="font-semibold text-gray-700 mb-3 flex items-center"><i class="fas fa-barcode mr-2"></i>
                    Buscar por ID (TMDb)</h3>
                <div class="flex gap-2">
                    <input type="number" id="tmdb-id-busca" placeholder="C칩digo TMDb (Ex: 550)"
                           class="flex-grow p-2 border border-suave rounded-lg focus:ring-principal focus:border-principal">
                    <button type="button" id="btn-buscar-tmdb-id"
                            class="bg-destaque-card hover:bg-blue-300 text-principal font-semibold py-2 px-4 rounded-lg transition duration-300">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <p id="busca-id-msg" class="text-xs text-danger mt-1 hidden">Erro na busca ou filme n칚o encontrado.</p>
            </div>

            <div id="busca-titulo-container" class="border p-4 rounded-lg bg-gray-50 hidden">
                <h3 class="font-semibold text-gray-700 mb-3 flex items-center"><i class="fas fa-film mr-2"></i> Buscar
                    Filme por T칤tulo (TMDb)</h3>
                <div class="flex gap-2 mb-2">
                    <input type="text" id="busca-titulo" placeholder="T칤tulo do filme (em portugu칡s)"
                           class="flex-grow p-2 border border-suave rounded-lg focus:ring-principal focus:border-principal">
                    <button type="button" id="btn-buscar-titulo"
                            class="bg-destaque-card hover:bg-blue-300 text-principal font-semibold py-2 px-4 rounded-lg transition duration-300">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div id="resultados-busca-titulo" class="max-h-40 overflow-y-auto space-y-1">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                <div class="md:col-span-2">
                    <label for="titulo-traduzido" class="block text-sm font-medium text-gray-700">T칤tulo Traduzido <span
                            class="text-danger">*</span></label>
                    <input type="text" id="titulo-traduzido" required
                           class="mt-1 block w-full p-2 border border-suave rounded-lg focus:ring-principal focus:border-principal input-uppercase">
                </div>

                <div class="md:col-span-2 grid grid-cols-3 gap-4">
                    <div class="col-span-2">
                        <label for="titulo-original" class="block text-sm font-medium text-gray-700">T칤tulo
                            Original</label>
                        <input type="text" id="titulo-original"
                               class="mt-1 block w-full p-2 border border-suave rounded-lg focus:ring-principal focus:border-principal input-uppercase">
                    </div>
                    <div>
                        <label for="data-release" class="block text-sm font-medium text-gray-700">Data
                            Lan칞amento</label>
                        <input type="date" id="data-release"
                               class="mt-1 block w-full p-2 border border-suave rounded-lg focus:ring-principal focus:border-principal">
                    </div>
                </div>

                <div class="md:col-span-2 grid grid-cols-3 gap-4">
                    <div>
                        <label for="ano" class="block text-sm font-medium text-gray-700">Ano <span
                                class="text-danger">*</span></label>
                        <input type="number" id="ano" required
                               class="mt-1 block w-full p-2 border border-suave rounded-lg focus:ring-principal focus:border-principal">
                    </div>

                    <div>
                        <label for="codigo-tmdb" class="block text-sm font-medium text-gray-700">C칩digo TMDb <span
                                class="text-danger">*</span></label>
                        <div class="input-icon-group mt-1">
                            <input type="text" id="codigo-tmdb" required
                                   class="focus:ring-principal focus:border-principal">
                            <a id="link-tmdb-modal" href="#" target="_blank"
                               class="bg-principal text-white hover:bg-blue-600 transition duration-300 disabled:opacity-50 disabled:pointer-events-none opacity-50 pointer-events-none"
                               title="Ver filme no TMDb">
                                <i class="fas fa-ticket-alt"></i>
                            </a>
                        </div>
                    </div>

                    <div>
                        <label for="codigo-imdb" class="block text-sm font-medium text-gray-700">C칩digo IMDB</label>
                        <div class="input-icon-group mt-1">
                            <input type="text" id="codigo-imdb"
                                   class="focus:ring-principal focus:border-principal">
                            <a id="link-imdb-modal" href="#" target="_blank"
                               class="bg-yellow-500 text-white hover:bg-yellow-600 transition duration-300 disabled:opacity-50 disabled:pointer-events-none opacity-50 pointer-events-none"
                               title="Ver filme no IMDb">
                                <i class="fab fa-imdb"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-2 grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Cor</label>
                        <div class="flex items-center space-x-4 mt-1">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="tipoCor" id="radio-pb" value="Preto Branco"
                                       class="h-4 w-4 text-principal focus:ring-principal border-gray-300">
                                <span class="ml-2 text-sm text-gray-700">P/B</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="tipoCor" id="radio-cores" value="Cores" checked
                                       class="h-4 w-4 text-principal focus:ring-principal border-gray-300">
                                <span class="ml-2 text-sm text-gray-700">Cor</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label for="pagina" class="block text-sm font-medium text-gray-700">P치gina</label>
                        <input type="text" id="pagina"
                               class="mt-1 block w-full p-2 border border-suave rounded-lg focus:ring-principal focus:border-principal">
                    </div>

                    <div>
                        <label for="pasta" class="block text-sm font-medium text-gray-700">Pasta</label>
                        <input type="text" id="pasta"
                               class="mt-1 block w-full p-2 border border-suave rounded-lg focus:ring-principal focus:border-principal">
                    </div>
                </div>
            </div>


            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pr칠-visualiza칞칚o do Cartaz</label>
                    <img id="poster-preview" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="
                         alt="Pr칠-visualiza칞칚o do Cartaz" class="p-2 border border-suave rounded-lg max-w-full">
                </div>
                <div>
                    <label for="sinopse" class="block text-sm font-medium text-gray-700">Sinopse</label>
                    <textarea id="sinopse" rows="18"
                              class="mt-1 block w-full p-2 border border-suave rounded-lg focus:ring-principal focus:border-principal resize-none"></textarea>
                </div>
            </div>

            <div>
                <label for="link-imagem" class="block text-sm font-medium text-gray-700">Link da Imagem do
                    Cartaz</label>
                <input type="url" id="link-imagem"
                       class="mt-1 block w-full p-2 border border-suave rounded-lg focus:ring-principal focus:border-principal">
            </div>

            <div id="cartazes-alternativos-container" class="border p-4 rounded-lg bg-gray-50 hidden">
                <h3 class="font-semibold text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-images mr-2"></i> Cartazes Alternativos
                </h3>
                <div id="cartazes-lista" class="flex overflow-x-auto space-x-3 p-1">
                    <p class="text-sm text-texto-suave" id="msg-sem-cartazes">Carregando cartazes...</p>
                </div>
            </div>

            <div class="flex justify-end space-x-3 pt-4 border-t border-suave">
                <button type="button" id="btn-cancelar"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-300">
                    <i class="fas fa-times mr-1"></i> Cancelar
                </button>
                <button type="submit" id="btn-salvar"
                        class="bg-edit hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
                    <i class="fas fa-save mr-1"></i> Salvar
                </button>
            </div>
        </form>
    </div>
</div>

<div id="modal-grafico" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl transform transition-all duration-300 overflow-y-auto max-h-[90vh]">

        <div class="p-4 border-b border-suave flex justify-between items-center bg-fundo-claro rounded-t-xl">
            <h2 class="text-xl font-bold text-principal flex items-center">
                <i class="fas fa-chart-line mr-2"></i> Distribui칞칚o de Filmes por Ano
            </h2>
            <button id="btn-fechar-grafico" class="text-gray-500 hover:text-danger text-2xl">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="p-6">
            <canvas id="grafico-filmes" class="w-full"></canvas>

            <div class="mt-4 text-center text-sm text-texto-suave">
                Dados baseados em todos os <span id="grafico-total-registros">0</span> filmes carregados.
            </div>
        </div>

    </div>
</div>

<div id="modal-login"
     class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden justify-center items-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-800">Acesso Administrativo</h3>
            <button id="btn-fechar-login" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>

        <form id="form-login">
            <div class="mb-4">
                <label for="input-login-nome" class="block text-sm font-medium text-gray-700 mb-1">Usu치rio
                    (Email)</label>
                <input type="text" id="input-login-nome" required
                       class="w-full p-2 border border-suave rounded-lg focus:ring-principal focus:border-principal">
            </div>

            <div class="mb-6">
                <label for="input-login-senha" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                <input type="password" id="input-login-senha" required
                       class="w-full p-2 border border-suave rounded-lg focus:ring-principal focus:border-principal">
            </div>

            <p id="mensagem-login" class="text-danger text-sm mb-4 hidden">Email ou senha incorretos.</p>

            <button type="submit" id="btn-submit-login"
                    class="w-full bg-principal text-white py-2 rounded-lg hover:bg-blue-600 transition duration-150">
                Entrar
            </button>
        </form>
    </div>
</div>

<script>
    // --- CONSTANTES E VARI츼VEIS GLOBAIS ---

    // ** 1. CREDENCIAIS SUPABASE **
    const SUPABASE_URL = 'https://kngdhvmwmbcnrcutuuqm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtuZ2Rodm13bWJjbnJjdXR1dXFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc1NTAzODksImV4cCI6MjA1MzEyNjM4OX0.iSycpy-YlpkiBpw4PC-0n4AIN0gxGs6OparYc5C0d20';
    const SUPABASE_TABLE = 'album';

    // ** 2. INICIALIZA칂츾O SUPABASE **
    const {createClient} = supabase; // Desestrutura a fun칞칚o para uso direto
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- Vari치veis TMDb ---
    const TMDB_API_KEY = '2b0120b7e901bbe70b631b2273fe28c9';
    const BASE_IMAGE_URL = 'https://image.tmdb.org/t/p/w500';
    const BASE_THUMB_URL = 'https://image.tmdb.org/t/p/w92';

    const FILMES_POR_PAGINA = 100;

    let filmes = [];
    let editandoId = null;
    let paginaAtual = 1;
    let totalRegistros = 0;
    let isLoggedIn = false;
    let sessionToken = null;

    // --- REFER칅NCIAS DE ELEMENTOS DOM (Mantidas as mesmas) ---
    const modal = document.getElementById('modal-filme');
    const modalTitulo = document.getElementById('modal-titulo');
    const btnNovoFilme = document.getElementById('btn-novo-filme');
    const btnFecharModal = document.getElementById('btn-fechar-modal');
    const btnCancelar = document.getElementById('btn-cancelar');
    const formFilme = document.getElementById('form-filme');
    const gradeFilmes = document.getElementById('grade-filmes');
    const msgSemFilmes = document.getElementById('msg-sem-filmes');

    const inputID = document.getElementById('filme-id');
    const inputTMDBBusca = document.getElementById('tmdb-id-busca');
    const btnBuscarTMDBID = document.getElementById('btn-buscar-tmdb-id');
    const inputTituloTraduzido = document.getElementById('titulo-traduzido');
    const inputAno = document.getElementById('ano');
    const inputCodigoTMDB = document.getElementById('codigo-tmdb');
    const inputCodigoIMDB = document.getElementById('codigo-imdb');
    const inputDataRelease = document.getElementById('data-release');
    const radioPB = document.getElementById('radio-pb');
    const radioCores = document.getElementById('radio-cores');
    const inputPagina = document.getElementById('pagina');
    const inputPasta = document.getElementById('pasta');
    const inputLinkImagem = document.getElementById('link-imagem');
    const inputTituloOriginal = document.getElementById('titulo-original');
    const inputSinopse = document.getElementById('sinopse');
    const posterPreview = document.getElementById('poster-preview');

    const cartazesAlternativosContainer = document.getElementById('cartazes-alternativos-container');
    const cartazesLista = document.getElementById('cartazes-lista');
    const msgSemCartazes = document.getElementById('msg-sem-cartazes');

    const sortCriterio = document.getElementById('sort-criterio');
    const sortOrdem = document.getElementById('sort-ordem');

    const inputBuscaTitulo = document.getElementById('busca-titulo');
    const btnBuscarTitulo = document.getElementById('btn-buscar-titulo');
    const resultadosBuscaTitulo = document.getElementById('resultados-busca-titulo');
    const buscaIDMsg = document.getElementById('busca-id-msg');
    const contadorRegistros = document.getElementById('contador-registros');

    const inputFiltroTitulo = document.getElementById('filtro-titulo');
    const inputFiltroAno = document.getElementById('filtro-ano');

    const selectFiltroCores = document.getElementById('filtro-cores');

    const radioBuscaTMDBId = document.getElementById('radio-busca-tmdb-id');
    const radioBuscaTitulo = document.getElementById('radio-busca-titulo');
    const buscaIdContainer = document.getElementById('busca-id-container');
    const buscaTituloContainer = document.getElementById('busca-titulo-container');

    const loadingSpinner = document.getElementById('loading-spinner');

    const btnAnterior = document.getElementById('btn-anterior');
    const btnProximo = document.getElementById('btn-proximo');
    const infoPaginacao = document.getElementById('info-paginacao');
    const btnPrimeira = document.getElementById('btn-primeira');
    const btnUltima = document.getElementById('btn-ultima');

    const linkTMDBModal = document.getElementById('link-tmdb-modal');
    const linkIMDBModal = document.getElementById('link-imdb-modal');

    const btnModalGrafico = document.getElementById('btn-modal-grafico');
    const modalGrafico = document.getElementById('modal-grafico');
    const btnFecharGrafico = document.getElementById('btn-fechar-grafico');
    const graficoTotalRegistros = document.getElementById('grafico-total-registros');

    const btnLogin = document.getElementById('btn-login');
    const modalLogin = document.getElementById('modal-login');
    const btnFecharLogin = document.getElementById('btn-fechar-login');
    const formLogin = document.getElementById('form-login');
    const inputLoginNome = document.getElementById('input-login-nome');
    const inputLoginSenha = document.getElementById('input-login-senha');
    const mensagemLogin = document.getElementById('mensagem-login');

    const btnToggleBusca = document.getElementById('btn-toggle-busca');
    const conteudoBuscaColapsavel = document.getElementById('conteudo-busca-colapsavel');
    const iconeToggleBusca = document.getElementById('icone-toggle-busca');

    const debouncedCarregarFilmes = debounce(carregarFilmes, 500); // 500 milissegundos (meio segundo)

    // --- FUN칂칏ES DE PERSIST칅NCIA (SUPABASE) ---
    async function carregarFilmes(resetPagina = false) {
        loadingSpinner.classList.remove('hidden');
        loadingSpinner.classList.add('flex');

        const criterio = sortCriterio.value;
        const isAscending = sortOrdem.value === 'crescente';

        if (resetPagina) {
            paginaAtual = 1;
        }

        const termoBuscaAno = parseInt(inputFiltroAno.value.trim());
        const filtroCor = selectFiltroCores.value;
        const termoBuscaTitulo = inputFiltroTitulo.value.trim().toLowerCase();

        const inicio = (paginaAtual - 1) * FILMES_POR_PAGINA;
        const fim = inicio + FILMES_POR_PAGINA - 1;

        // Inicia a query base
        let query = supabaseClient.from(SUPABASE_TABLE).select('*', {count: 'exact'});

        if (filtroCor && filtroCor.length > 0) {
            query = query.eq('cores', filtroCor);
        }
        if (!isNaN(termoBuscaAno)) {
            query = query.eq('ano', termoBuscaAno);
        }

        if (termoBuscaTitulo.length > 0) {
            const orFilter = `titulo_traduzido.ilike.%${termoBuscaTitulo}%,titulo_original.ilike.%${termoBuscaTitulo}%`;
            query = query.or(orFilter);
        }

        try {
            const {data, count, error} = await query
                .range(inicio, fim)
                .order(criterio, {ascending: isAscending});

            if (error) throw error;

            totalRegistros = count || 0;
            filmes = data || [];

            renderizarFilmes();

        } catch (e) {
            console.error('Erro no carregamento:', e);
            alert(`Erro ao carregar dados: ${e.message}`);
        } finally {
            loadingSpinner.classList.add('hidden');
            loadingSpinner.classList.remove('flex');
        }
    }

    /** Controla a navega칞칚o para a p치gina anterior. */
    function navegarPaginaAnterior() {
        if (paginaAtual > 1) {
            paginaAtual--;
            carregarFilmes(false); // Carrega os novos filmes
            window.scrollTo(0, 0);
        }
    }

    /** Controla a navega칞칚o para a pr칩xima p치gina. */
    function navegarPaginaProxima() {
        const totalPaginas = Math.ceil(totalRegistros / FILMES_POR_PAGINA);
        if (paginaAtual < totalPaginas) {
            paginaAtual++;
            carregarFilmes(false); // Carrega os novos filmes
            window.scrollTo(0, 0);
        }
    }

    /** Controla a navega칞칚o para a Primeira p치gina. */
    function navegarPrimeiraPagina() {
        if (paginaAtual !== 1) {
            paginaAtual = 1;
            carregarFilmes(false); // Mant칠m o filtro, mas muda a p치gina
            window.scrollTo(0, 0);
        }
    }

    /** Controla a navega칞칚o para a 칔ltima p치gina. */
    function navegarUltimaPagina() {
        const totalPaginas = Math.ceil(totalRegistros / FILMES_POR_PAGINA);
        if (paginaAtual !== totalPaginas) {
            paginaAtual = totalPaginas;
            carregarFilmes(false); // Mant칠m o filtro, mas muda a p치gina
            window.scrollTo(0, 0);
        }
    }

    /** Constr칩i e atualiza o link TMDb no modal. */
    function atualizarLinkTMDB() {
        const tmdbId = inputCodigoTMDB.value.trim();

        if (tmdbId) {
            linkTMDBModal.href = `https://www.themoviedb.org/movie/${tmdbId}`;
            linkTMDBModal.classList.remove('opacity-50', 'pointer-events-none');
        } else {
            linkTMDBModal.href = '#';
            linkTMDBModal.classList.add('opacity-50', 'pointer-events-none');
        }
    }

    /** Constr칩i e atualiza o link IMDb no modal. */
    function atualizarLinkIMDB() {
        const imdbId = inputCodigoIMDB.value.trim();
        if (imdbId) {
            linkIMDBModal.href = `https://www.imdb.com/title/${imdbId}`;
            linkIMDBModal.classList.remove('opacity-50', 'pointer-events-none');
        } else {
            linkIMDBModal.href = '#';
            linkIMDBModal.classList.add('opacity-50', 'pointer-events-none');
        }
    }

    // --- FUN칂칏ES DO MODAL/FORMUL츼RIO ---

    /** Alterna a exibi칞칚o entre o campo de busca por ID e por T칤tulo. */
    function alternarBusca(modo) {
        if (modo === 'id') {
            buscaIdContainer.classList.remove('hidden');
            buscaTituloContainer.classList.add('hidden');
        } else if (modo === 'titulo') {
            buscaIdContainer.classList.add('hidden');
            buscaTituloContainer.classList.remove('hidden');
        }
    }

    /** Mapeia dados do Supabase para os campos do formul치rio (Filme -> Formul치rio) */
    function preencherFormulario(filme) {
        editandoId = filme.id;
        inputTMDBBusca.value = '';
        modalTitulo.textContent = `Editar Filme (ID: ${filme.id})`;

        // Mapeamento das colunas da tabela 'album' para os campos do formul치rio
        inputID.value = filme.id;
        inputTituloTraduzido.value = filme.titulo_traduzido || '';
        inputAno.value = filme.ano;
        inputCodigoTMDB.value = filme.tmdb;
        inputCodigoIMDB.value = filme.imdb || '';

        // Tipo de Cor (coluna 'cores')
        if (filme.cores === 'Preto Branco') {
            radioPB.checked = true;
            radioCores.checked = false;
        } else {
            radioCores.checked = true;
            radioPB.checked = false;
        }

        inputPagina.value = filme.pagina || '';
        inputPasta.value = filme.pasta || '';
        inputLinkImagem.value = filme.link_imagem || '';
        inputDataRelease.value = filme.data_release || '';
        inputTituloOriginal.value = filme.titulo_original || '';
        inputSinopse.value = filme.sinopse || '';
        posterPreview.src = filme.link_imagem || 'data:image:gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';

        inputTMDBBusca.value = filme.tmdb;
        resultadosBuscaTitulo.innerHTML = '';
        buscaIDMsg.classList.add('hidden');
        cartazesAlternativosContainer.classList.add('hidden');

        modal.classList.remove('hidden');
        modal.classList.add('flex');

        buscarCartazes(filme.tmdb);

        atualizarLinkTMDB();
        atualizarLinkIMDB();
    }

    /** Abre o modal e preenche com os dados do filme para edi칞칚o. */
    function abrirModalEdicao(id) {
        const filme = filmes.find(f => f.id === id);
        if (!filme) return;

        preencherFormulario(filme);
    }

    /** Limpa e abre o modal para um novo cadastro. */
    function abrirModalNovo() {
        editandoId = null;
        modalTitulo.textContent = 'Adicionar Novo Filme';
        formFilme.reset();
        inputTMDBBusca.value = '';
        radioCores.checked = true;
        posterPreview.src = 'data:image:gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
        resultadosBuscaTitulo.innerHTML = '';
        buscaIDMsg.classList.add('hidden');
        cartazesAlternativosContainer.classList.add('hidden');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        atualizarLinkTMDB();
        atualizarLinkIMDB();
    }

    /** Fecha o modal. */
    function fecharModal() {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    /** Lida com o envio do formul치rio (Adicionar ou Editar) no Supabase. */
    formFilme.addEventListener('submit', async function (e) {
        e.preventDefault();

        const tipoCorSelecionado = document.querySelector('input[name="tipoCor"]:checked');

        // Mapeamento dos campos do formul치rio para as COLUNAS da tabela 'album'
        const dadosFilme = {
            tmdb: getIntOrNull(inputCodigoTMDB.value),
            imdb: inputCodigoIMDB.value.trim() || null,
            titulo_original: inputTituloOriginal.value.trim().toUpperCase() || null,
            titulo_traduzido: inputTituloTraduzido.value.trim().toUpperCase() || null,
            pagina: inputPagina.value.trim() || 0,
            pasta: inputPasta.value.trim() || 0,
            data_release: inputDataRelease.value.trim() || null,
            ano: getIntOrNull(inputAno.value),
            link_imagem: inputLinkImagem.value.trim() || null,
            sinopse: inputSinopse.value.trim() || null,
            cores: tipoCorSelecionado ? tipoCorSelecionado.value : 'Cores',
        };

        if (editandoId) {
            // MODO EDI칂츾O
            const response = await supabaseClient
                .from(SUPABASE_TABLE)
                .update(dadosFilme)
                .eq('id', editandoId); // Usa o ID do Supabase para o WHERE
            error = response.error;
        } else {
            // MODO NOVO
            const response = await supabaseClient
                .from(SUPABASE_TABLE)
                .insert([dadosFilme]);
            error = response.error;
        }

        if (error) {
            console.error('Erro ao salvar no Supabase:', error);
            alert(`Erro ao salvar: ${error.message}. Verifique o RLS.`);
        } else {
            await carregarFilmes(true);
            fecharModal();
        }
    });

    function alternarBuscaPrincipal() {
        const isCollapsed = conteudoBuscaColapsavel.classList.contains('max-h-0');

        if (isCollapsed) {
            // Expande
            conteudoBuscaColapsavel.classList.remove('max-h-0', 'border-t');
            conteudoBuscaColapsavel.classList.add('max-h-screen');
            iconeToggleBusca.classList.remove('fa-chevron-down');
            iconeToggleBusca.classList.add('fa-chevron-up');
        } else {
            // Colapsa
            conteudoBuscaColapsavel.classList.remove('max-h-screen');
            conteudoBuscaColapsavel.classList.add('max-h-0', 'border-t');
            iconeToggleBusca.classList.remove('fa-chevron-up');
            iconeToggleBusca.classList.add('fa-chevron-down');
        }
    }

    // --- FUN칂칏ES DE RENDERIZA칂츾O E ORDENA칂츾O ---
    function criarCardFilme(filme) {
        const card = document.createElement('div');
        card.className = 'group bg-white rounded-lg shadow-lg hover:shadow-xl transition duration-300 overflow-hidden border border-suave';
        card.setAttribute('data-id', filme.id);

        const imageUrl = filme.link_imagem || '';
        const placeholderText = 'SEM CARTAZ';

        const botoesAcaoHtml = isLoggedIn ? `
        <div class="absolute inset-0 flex flex-col justify-end p-2 bg-black bg-opacity-40
                    transition-opacity duration-300 opacity-0 group-hover:opacity-100">
            <div class="flex space-x-2">
                <button class="flex-1 py-2 px-1 bg-edit/90 hover:bg-edit text-white font-semibold rounded-lg transition duration-300 btn-editar" data-id="${filme.id}">
                    <i class="fas fa-edit mr-1"></i> Editar
                </button>
                <button class="flex-1 py-2 px-1 bg-danger/90 hover:bg-danger text-white font-semibold rounded-lg transition duration-300 btn-excluir" data-id="${filme.id}">
                    <i class="fas fa-trash-alt mr-1"></i> Excluir
                </button>
            </div>
        </div>
    ` : '';

        // Usa innerHTML para preencher o conte칰do
        card.innerHTML = `
        <div class="poster-area">
            ${imageUrl ?
            `<img src="${imageUrl}"
                      alt="${filme.titulo_traduzido} Cartaz"
                      class="card-poster">`
            :
            `<div class="card-poster flex items-center justify-center text-xl font-bold text-texto-suave bg-[#f3f4f6] p-2">
                         ${placeholderText}
                     </div>`
        }

            ${botoesAcaoHtml}
        </div>

        <div class="p-3 text-center">
            <h3 class="text-sm font-bold text-gray-800 truncate input-uppercase" title="${filme.titulo_traduzido}">${filme.titulo_traduzido}</h3>

            ${filme.titulo_original ? `<p class="text-xs text-texto-suave truncate italic mt-[-2px] mb-1 input-uppercase" title="T칤tulo Original">${filme.titulo_original}</p>` : ''}

            <p class="text-xs text-texto-suave flex justify-center items-center space-x-2">
                ${filme.tmdb ? `
                    <a href="https://www.themoviedb.org/movie/${filme.tmdb}" target="_blank" class="text-principal hover:underline font-semibold flex items-center" title="Ver filme no TMDb">
                        <i class="fas fa-ticket-alt mr-1 text-gray-500"></i> TMDB
                    </a>
                ` : ''}

                ${filme.imdb ? `
                    <a href="https://www.imdb.com/title/${filme.imdb}" target="_blank" class="text-principal hover:underline font-semibold flex items-center" title="Ver filme no IMDb">
                        <i class="fab fa-imdb mr-1 text-yellow-500"></i> IMDB
                    </a>
                ` : ''}
            </p>

            <p class="text-xs text-texto-suave truncate">
                ${filme.pagina ? `P치g: ${filme.pagina}` : ''}
                ${(filme.pagina && filme.pasta) ? ` | ` : ''}
                ${filme.pasta ? `Pasta: ${filme.pasta}` : ''}
            </p>

            <p class="text-xs font-semibold mt-1 text-texto-suave">
                <span>${filme.ano}</span>
                <span class="ml-1">
                    | ${filme.cores || 'Cores'}
                </span>
            </p>
        </div>
    `;
        // Retorna o elemento DIV (o Node)
        return card;
    }

    // RENDERIZAR FILMES
    function renderizarFilmes() {

        loadingSpinner.classList.remove('hidden');
        loadingSpinner.classList.add('flex');

        // setTimeout garante que o spinner apare칞a antes da renderiza칞칚o
        setTimeout(() => {
            gradeFilmes.innerHTML = '';

            // ** 1. A FILTRAGEM J츼 FOI FEITA PELO SUPABASE. Apenas renderizamos 'filmes' **
            let listaFiltrada = [...filmes];

            // Se o Supabase n칚o encontrou nada (ex: Filtro errado), listaFiltrada.length ser치 0
            const totalFilmesRenderizados = listaFiltrada.length;

            if (totalFilmesRenderizados === 0) {
                // Mensagem gen칠rica, pois o Supabase j치 aplicou o filtro
                msgSemFilmes.textContent = `Nenhum filme encontrado na P치gina ${paginaAtual} para os filtros aplicados.`;
                msgSemFilmes.classList.remove('hidden');

            } else {
                msgSemFilmes.classList.add('hidden');

                // Renderiza a lista (m치x. FILMES_POR_PAGINA)
                listaFiltrada.forEach(filme => {
                    const card = criarCardFilme(filme);
                    gradeFilmes.appendChild(card);
                });
            }

            // 2. ATUALIZA IU DE PAGINA칂츾O (Mantido)
            const totalPaginas = Math.ceil(totalRegistros / FILMES_POR_PAGINA);
            infoPaginacao.textContent = `P치gina ${paginaAtual} de ${totalPaginas} (${totalRegistros} total)`;

            btnAnterior.disabled = paginaAtual === 1;
            btnProximo.disabled = paginaAtual === totalPaginas || totalPaginas === 0;
            btnPrimeira.disabled = paginaAtual === 1 || totalPaginas === 0;
            btnUltima.disabled = paginaAtual === totalPaginas || totalPaginas === 0;

            // 3. ATUALIZA CONTADOR GERAL (Mantido)
            contadorRegistros.textContent = `${totalRegistros.toString().padStart(2, '0')} Registros`;

            loadingSpinner.classList.add('hidden');
            loadingSpinner.classList.remove('flex');

        }, 50);
    }

    gradeFilmes.addEventListener('click', function (e) {
        const target = e.target.closest('.btn-editar, .btn-excluir');
        if (!target) return;

        const id = parseInt(target.getAttribute('data-id'));

        if (target.classList.contains('btn-editar')) {
            abrirModalEdicao(id);
        } else if (target.classList.contains('btn-excluir')) {
            excluirFilme(id);
        }
    });

    async function excluirFilme(id) {

        // 1. Encontra o objeto do filme no array local
        const filme = filmes.find(f => f.id === id);

        // Se por algum motivo n칚o encontrar o filme (dados desatualizados), usa o ID como fallback
        const tituloParaExcluir = filme ? filme.titulo_traduzido : `ID ${id}`;

        // 2. Exibe a confirma칞칚o usando o t칤tulo do filme
        if (confirm(`Tem certeza que deseja excluir o filme "${tituloParaExcluir}"?`)) {
            const {error} = await supabaseClient
                .from(SUPABASE_TABLE)
                .delete()
                .eq('id', id);

            if (error) {
                console.error('Erro ao excluir:', error);
                alert(`Erro ao excluir: ${error.message}`);
            } else {
                await carregarFilmes(true);
            }
        }
    }

    // --- FUN칂칏ES DE BUSCA (API TMDb) ---
    async function buscarCartazes(tmdbId) {
        cartazesLista.innerHTML = '';
        msgSemCartazes.textContent = 'Carregando cartazes...';
        cartazesAlternativosContainer.classList.remove('hidden');

        const url = `https://api.themoviedb.org/3/movie/${tmdbId}/images?api_key=${TMDB_API_KEY}`;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Erro ao buscar imagens.');

            const data = await response.json();

            const cartazesBR = data.posters
                .filter(poster => poster.iso_639_1 === 'pt' || poster.iso_639_1 === 'en' || !poster.iso_639_1)
                .sort((a, b) => b.vote_count - a.vote_count);

            if (cartazesBR.length > 0) {
                msgSemCartazes.classList.add('hidden');

                cartazesBR.slice(0, 10).forEach(poster => {
                    const fullPath = poster.file_path;
                    const thumbUrl = `${BASE_THUMB_URL}${fullPath}`;
                    const fullUrl = `${BASE_IMAGE_URL}${fullPath}`;

                    const img = document.createElement('img');
                    img.src = thumbUrl;
                    img.alt = 'Cartaz Alternativo';
                    img.className = 'w-16 h-24 object-cover rounded-md cursor-pointer border-2 border-transparent hover:border-principal transition duration-150';
                    img.setAttribute('data-full-url', fullUrl);

                    // Adiciona o evento de clique
                    img.addEventListener('click', () => {
                        inputLinkImagem.value = fullUrl;
                        posterPreview.src = fullUrl;
                    });

                    cartazesLista.appendChild(img);
                });
            } else {
                msgSemCartazes.textContent = 'Nenhum cartaz alternativo encontrado.';
                msgSemCartazes.classList.remove('hidden');
            }

        } catch (error) {
            console.error('Erro ao buscar cartazes alternativos:', error);
            msgSemCartazes.textContent = 'Erro ao carregar cartazes.';
            msgSemCartazes.classList.remove('hidden');
        }
    }

    async function buscarFilmePorId(tmdbId) {
        if (!tmdbId) return;

        buscaIDMsg.classList.add('hidden');
        btnBuscarTMDBID.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btnBuscarTMDBID.disabled = true;

        const url = `https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${TMDB_API_KEY}&language=pt-BR`;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Filme n칚o encontrado ou erro na API.');

            const data = await response.json();

            // Preenche os campos
            inputCodigoTMDB.value = data.id;
            inputCodigoIMDB.value = data.imdb_id || '';
            inputTituloOriginal.value = data.original_title;
            inputTituloTraduzido.value = data.title;
            inputAno.value = data.release_date ? data.release_date.substring(0, 4) : '';

            if (data.release_date) {
                inputAno.value = data.release_date.substring(0, 4); // Ano (YYYY)
                inputDataRelease.value = data.release_date; // Data completa (YYYY-MM-DD)
            } else {
                inputAno.value = '';
                inputDataRelease.value = '';
            }

            inputSinopse.value = data.overview;

            const posterPath = data.poster_path;
            const fullImageUrl = posterPath ? `${BASE_IMAGE_URL}${posterPath}` : '';
            inputLinkImagem.value = fullImageUrl;
            posterPreview.src = fullImageUrl || 'https://via.placeholder.com/500x750?text=Sem+Cartaz';

            buscarCartazes(tmdbId);

        } catch (error) {
            console.error('Erro na busca por ID TMDb:', error);
            buscaIDMsg.textContent = 'Erro na busca ou ID TMDb inv치lido.';
            buscaIDMsg.classList.remove('hidden');
        } finally {
            btnBuscarTMDBID.innerHTML = '<i class="fas fa-sync-alt"></i>';
            btnBuscarTMDBID.disabled = false;

            atualizarLinkTMDB();
            atualizarLinkIMDB();
        }
    }

    async function buscarFilmePorTitulo(titulo) {
        if (!titulo) return;

        btnBuscarTitulo.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btnBuscarTitulo.disabled = true;
        resultadosBuscaTitulo.innerHTML = '';

        const url = `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&language=pt-BR&query=${encodeURIComponent(titulo)}`;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Erro na API de busca.');

            const data = await response.json();

            if (data.results && data.results.length > 0) {
                data.results.slice(0, 5).forEach(filme => {
                    const item = document.createElement('div');
                    item.className = 'p-2 bg-white hover:bg-destaque-card cursor-pointer rounded-md border border-suave text-sm flex justify-between items-center';
                    item.setAttribute('data-tmdb-id', filme.id);
                    item.innerHTML = `
                            <span>${filme.title} (${filme.release_date ? filme.release_date.substring(0, 4) : 'N/A'})</span>
                            <i class="fas fa-hand-pointer text-principal"></i>
                        `;
                    item.addEventListener('click', () => {
                        buscarFilmePorId(filme.id);
                        resultadosBuscaTitulo.innerHTML = '';
                        inputBuscaTitulo.value = '';
                    });
                    resultadosBuscaTitulo.appendChild(item);
                });
            } else {
                resultadosBuscaTitulo.innerHTML = '<p class="text-texto-suave italic p-2">Nenhum resultado encontrado para o t칤tulo.</p>';
            }

        } catch (error) {
            console.error('Erro na busca por T칤tulo TMDb:', error);
            resultadosBuscaTitulo.innerHTML = '<p class="text-danger italic p-2">Erro ao buscar no TMDb. Verifique sua chave de API.</p>';
        } finally {
            btnBuscarTitulo.innerHTML = '<i class="fas fa-search"></i>';
            btnBuscarTitulo.disabled = false;
        }
    }

    /***************************************************/
    /************* FUN칂칏ES DE AUTH E ADMIN UI **********/
    /***************************************************/

    function atualizarUIAdmin(logado) {
        isLoggedIn = logado;

        // 1. Alterna o bot칚o NOVO e o bot칚o Login/Logout
        if (logado) {
            btnNovoFilme.classList.remove('hidden');
            btnLogin.innerHTML = '<i class="fas fa-sign-out-alt mr-2"></i> Logout';
            btnLogin.classList.remove('bg-texto-suave');
            btnLogin.classList.add('bg-danger');
            // REMOVIDO: exibirToast('Login realizado com sucesso!', 'bg-edit');
        } else {
            btnNovoFilme.classList.add('hidden');
            btnLogin.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i> Login';
            btnLogin.classList.remove('bg-danger');
            btnLogin.classList.add('bg-texto-suave');
            // REMOVIDO: exibirToast('Logout realizado com sucesso!', 'bg-principal');
        }

        // 2. Re-renderiza a lista para atualizar os bot칫es de Editar/Excluir nos cards
        renderizarFilmes();
    }

    /** Fun칞칚o principal para fazer login via Supabase Auth. */
    async function fazerLogin(e) {
        e.preventDefault();

        const email = inputLoginNome.value.trim();
        const password = inputLoginSenha.value.trim();
        mensagemLogin.classList.add('hidden');

        if (!email || !password) return;

        try {
            // Usa o m칠todo Auth, que criptografa e valida a senha no servidor
            const {error} = await supabaseClient.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) throw error;

            // Login bem-sucedido
            atualizarUIAdmin(true);
            fecharModalLogin();

        } catch (error) {
            console.error('Erro ao fazer login:', error.message);
            mensagemLogin.textContent = 'Email ou senha inv치lidos. Tente novamente.';
            mensagemLogin.classList.remove('hidden');
        }
    }

    /** Fun칞칚o para fazer logout. */
    async function fazerLogout() {
        await supabaseClient.auth.signOut();
        atualizarUIAdmin(false);
        exibirToast('Logout realizado com sucesso!', 'bg-principal');
        carregarFilmes(true);
    }

    /** Abre o modal de login. */
    function abrirModalLogin() {
        modalLogin.classList.remove('hidden');
        modalLogin.classList.add('flex');
        inputLoginNome.focus();
    }

    /** Fecha o modal de login. */
    function fecharModalLogin() {
        modalLogin.classList.add('hidden');
        modalLogin.classList.remove('flex');
        mensagemLogin.classList.add('hidden');
        formLogin.reset();
    }

    /** Checa se existe uma sess칚o Supabase ativa ao carregar a p치gina. */
    async function checkInitialSession() {
        const {data: {session}} = await supabaseClient.auth.getSession();
        if (session) {
            // Se houver sess칚o, atualiza a UI para logado
            atualizarUIAdmin(true);
        } else {
            // Se n칚o houver sess칚o, garante que a UI esteja deslogada
            atualizarUIAdmin(false);
        }
    }

    /***************************************************/
    /************* FUNCOES DE GRAFICO *****************/
    /***************************************************/

    let meuGrafico = null;

    /** Processa o array de filmes para contar a frequ칡ncia de cada ano. */
    function processarDadosGrafico(filmesArray) {
        const contagemAnos = {};

        filmesArray.forEach(filme => {
            const ano = parseInt(filme.ano);

            // CR칈TICO: Checa se o ano 칠 um N칔MERO, se 칠 maior que 1800 (para excluir 0, NaN) E MENOR que 9999
            if (!isNaN(ano) && ano > 1800 && ano <= 9999) {
                contagemAnos[ano] = (contagemAnos[ano] || 0) + 1;
            }
        });

        // Ordena os anos como N칔MEROS
        const anosOrdenados = Object.keys(contagemAnos)
            .sort((a, b) => parseInt(a) - parseInt(b));

        const dados = anosOrdenados.map(ano => contagemAnos[ano]);

        return {
            labels: anosOrdenados,
            dados: dados,
        };
    }

    /** Desenha o gr치fico de barras. */
    function desenharGrafico(dadosProcessados) {

        const canvasElement = document.getElementById('grafico-filmes');
        if (!canvasElement) return;

        // 1. Destruir e Resetar
        if (meuGrafico) {
            meuGrafico.destroy();
            meuGrafico = null;
        }

        // Limpeza expl칤cita do Canvas
        const ctx = canvasElement.getContext('2d');
        ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        // NOVO C츼LCULO CR칈TICO DE ALTURA
        const NUM_ANOS = dadosProcessados.labels.length;
        const ALTURA_POR_BARRA = 20; // 20px por barra (um valor seguro)
        const ALTURA_NECESSARIA = Math.max(400, NUM_ANOS * ALTURA_POR_BARRA); // M칤nimo de 400px

        // Aplica a altura calculada ao Canvas via estilo
        canvasElement.style.height = `${ALTURA_NECESSARIA}px`;


        // 2. Cria a nova inst칙ncia (Configura칞칚o de Barras HORIZONTAL)
        meuGrafico = new Chart(canvasElement, {
            type: 'bar',
            data: {
                labels: dadosProcessados.labels,
                datasets: [{
                    label: 'N칰mero de Filmes',
                    data: dadosProcessados.dados,
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: false, // Mantido para evitar loop
                maintainAspectRatio: false,
                indexAxis: 'y', // Gr치fico Horizontal
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: { // Eixo X 칠 a QUANTIDADE (horizontal)
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Quantidade de Filmes'
                        },
                        ticks: {
                            precision: 0,
                            stepSize: 100
                        }
                    },
                    y: { // Eixo Y 칠 o ANO (vertical)
                        title: {
                            display: true,
                            text: 'Ano de Lan칞amento'
                        },
                        ticks: {
                            autoSkip: false // CR칈TICO: Exibe todos os anos
                        }
                    }
                }
            }
        });
    }

    async function abrirModalGrafico() {
        loadingSpinner.classList.remove('hidden');
        loadingSpinner.classList.add('flex');

        // 1. EXECUTA UMA NOVA BUSCA COMPLETA APENAS PARA O GR츼FICO
        const {data, error} = await supabaseClient
            .from(SUPABASE_TABLE)
            .select('ano') // Busca APENAS a coluna 'ano'
            .range(0, 4999); // Limite alto para pegar todos os registros

        loadingSpinner.classList.add('hidden');
        loadingSpinner.classList.remove('flex');

        if (error) {
            console.error('Erro ao buscar dados para o gr치fico:', error);
            alert('Erro ao carregar todos os dados para o gr치fico.');
            return;
        }

        const todosOsAnos = data || [];

        // 2. PROCESSA OS DADOS COMPLETOS
        const dadosProcessados = processarDadosGrafico(todosOsAnos);

        // 3. Exibe o modal
        modalGrafico.classList.remove('hidden');
        modalGrafico.classList.add('flex');

        graficoTotalRegistros.textContent = totalRegistros;

        // 4. Desenha o gr치fico (Com os dados COMPLETO e processados)
        setTimeout(() => {
            desenharGrafico(dadosProcessados);
        }, 100);
    }

    /** Fecha o modal do gr치fico. */
    function fecharModalGrafico() {
        modalGrafico.classList.add('hidden');
        modalGrafico.classList.remove('flex');
    }

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }

    /***************************************************/
    /************* LISTENERS DE EVENTOS *****************/
    /***************************************************/

    btnNovoFilme.addEventListener('click', abrirModalNovo);
    btnCancelar.addEventListener('click', fecharModal);
    btnFecharModal.addEventListener('click', fecharModal);

    selectFiltroCores.addEventListener('change', () => carregarFilmes(true));
    sortCriterio.addEventListener('change', () => carregarFilmes(true));
    sortOrdem.addEventListener('change', () => carregarFilmes(true));

    btnToggleBusca.addEventListener('click', alternarBuscaPrincipal);

    // btnAplicarOrdenacao.addEventListener('click', () => carregarFilmes(true));

    inputLinkImagem.addEventListener('input', (e) => {
        posterPreview.src = e.target.value || 'data:image:gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
    });

    btnPrimeira.addEventListener('click', navegarPrimeiraPagina);
    btnUltima.addEventListener('click', navegarUltimaPagina);
    btnAnterior.addEventListener('click', navegarPaginaAnterior);
    btnProximo.addEventListener('click', navegarPaginaProxima);

    btnBuscarTMDBID.addEventListener('click', () => {
        const tmdbId = parseInt(inputTMDBBusca.value.trim());
        if (tmdbId) {
            buscarFilmePorId(tmdbId);
        }
    });

    btnBuscarTitulo.addEventListener('click', () => {
        const titulo = inputBuscaTitulo.value.trim();
        if (titulo) {
            buscarFilmePorTitulo(titulo);
        }
    });

    inputCodigoTMDB.addEventListener('input', atualizarLinkTMDB);
    inputCodigoIMDB.addEventListener('input', atualizarLinkIMDB);

    document.addEventListener('keydown', function (e) {
        // Verifica se a tecla pressionada 칠 'Escape' (ou keyCode 27)
        if (e.key === 'Escape' || e.keyCode === 27) {
            // Verifica se o modal est치 vis칤vel (se n칚o tem a classe 'hidden')
            if (!modal.classList.contains('hidden')) {
                fecharModal(); // Chama a fun칞칚o que fecha o modal
            }
        }
    });

    // function checarEnterBusca(e) {
    //     // Verifica se a tecla pressionada 칠 'Enter' (ou keyCode 13)
    //     if (e.key === 'Enter' || e.keyCode === 13) {
    //         e.preventDefault(); // Impede o envio de formul치rio
    //         carregarFilmes(true); // Executa a busca (reseta a p치gina)
    //     }
    // }

    // inputFiltroTitulo.addEventListener('keydown', checarEnterBusca);
    // inputFiltroAno.addEventListener('keydown', checarEnterBusca);
    inputFiltroTitulo.addEventListener('input', () => debouncedCarregarFilmes(true));
    inputFiltroAno.addEventListener('input', () => debouncedCarregarFilmes(true));
    selectFiltroCores.addEventListener('change', () => carregarFilmes(true));

    /** Converte um valor de input para inteiro, retornando null se o campo estiver vazio ou for NaN. */
    function getIntOrNull(inputValue) {
        const value = inputValue.trim();
        if (!value) return null; // Retorna null se estiver vazio
        const num = parseInt(value);
        return isNaN(num) ? null : num; // Retorna o n칰mero ou null se for inv치lido
    }

    radioBuscaTMDBId.addEventListener('change', () => alternarBusca('id'));
    radioBuscaTitulo.addEventListener('change', () => alternarBusca('titulo'));

    btnModalGrafico.addEventListener('click', abrirModalGrafico);
    btnFecharGrafico.addEventListener('click', fecharModalGrafico);

    // Opcional: Fechar gr치fico com ESC
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' || e.keyCode === 27) {
            if (!modalGrafico.classList.contains('hidden')) {
                fecharModalGrafico();
            }
        }
    });

    btnLogin.addEventListener('click', () => {
        if (isLoggedIn) {
            fazerLogout(); // Se logado, faz logout
        } else {
            abrirModalLogin(); // Se deslogado, abre o modal
        }
    });

    btnFecharLogin.addEventListener('click', fecharModalLogin);
    formLogin.addEventListener('submit', fazerLogin);

    // --- INICIALIZA칂츾O ---
    window.onload = function() {
        checkInitialSession(); // NOVO: Checa a sess칚o de login primeiro
        carregarFilmes(true);
        alternarBusca('titulo');
    };
</script>
</body>
</html>